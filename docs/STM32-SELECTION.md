# STM32 Selection

## Supported STM32 Microcontrollers

The following table provides details about the supported STM32 microcontrollers:

| Model | Flash | RAM | Max Clock Speed | Max ROM Images | Build variant |
|-------|-------|-----|-----------------|----------------|---------------|
| STM32F401RBT6 | 128KB | 96KB | 84MHz | 6 | f401rb |
| STM32F401RCT6 | 256KB | 96KB | 84MHz | 14 | f401rc |
| STM32F401RET6 | 512KB | 96KB | 84MHz | 16 | f401re |
| STM32F411RCT6 | 256KB | 128KB | 100MHz | 14 | f411rc |
| STM32F411RET6 | 512KB | 128KB | 100MHz | 16 | f411re |
| STM32F405RGT6 | 1024KB | 128KB | 168MHz | 16 | f405rg |
| STM32F446RCT6 | 256KB | 128KB | 180MHz | 16 | f446rc |
| STM32F446RETx | 512KB | 128KB | 180MHz | 16 | f446re |

## Clock Speed Requirements

Ideally, you should not specify the `FREQ` build variable, which will cause the firmware to operate the STM32 variant you choose at its maximum clock speed.

However, if you need to specify a lower clock speed, to reduce power draw/heat you can do so by setting the `FREQ` build variable to a value that is less than or equal to the maximum clock speed of the selected STM32 variant.  See [`FREQ`](/docs/CONFIGURATION.md#freq) for more details.

Different retro systems, and different use cases, have different minimum clock speed requirements.  Some example minimum clock speeds are given in the following table.  They were generated by testing against real retro systems and are absolute minima.  Your mileage may vary and it would be advisable to add some headroom to these figures - and you may need to experiment with different clock speeds to find the best one for your system.

Alternatively, use an STM32F405 or STM32F446 and run at maximum clock speed, both of which support all of the systems below.

| System | Video | ROM Type | Minimum Frequency | Suitable STM32 Variant |
|--------|-------|----------|-------------------|---------------|
| PET 4032 | 40 Col 50Hz | Kernal | 26MHz | F401/F411/F405/F446 |
| PET 4032 | 40 Col 50Hz | Character | 26MHz | F401/F411/F405/F446 |
| VIC 20 | PAL | Kernal | 37MHz | F401/F411/F405/F446 |
| VIC 20 | PAL | Basic | 37MHz | F401/F411/F405/F446 |
| VIC 20 | PAL | Character | 72MHz | F401/F411/F405/F446 |
| C64 | PAL | Kernal | 75MHz | F401/F411/F405/F446 |
| C64 | PAL | Character | 98MHz | F411/F405/F446 |

## ROM Image Capacity

Each ROM image consumes 16KB of flash (irrespective of the ROM type - see [Technical Details](/docs/TECHNICAL-DETAILS.md) for why), so the maximum number of ROM images that can be stored is limited by the flash size for smaller variants.  The SDRR firmware itself consumes between 16-32KB of flash.  The rest of the flash can be used for images, up to a maximum of 16, which is limited by the number of select jumpers on the PCB, which in turn is limited by the phyical size of the original ROM footprint.

## Supporting Other Variants

If you have a different variant, the easiest way to support it is to choose a version above which is of the same or higher power than your chosen variant, and select that version.

If you want to add build support for another variant:

- Add it to [`Makefile`](/Makefile) - see the `STM` variable.
- Add it to [`sdrr/Makefile`](/sdrr/Makefile) - see the `Linker script selection` section.
- Add it to [`sddr-gen`](/rust/sdrr-gen), in particular:
  - [`sdrr-gen/src/main.rs`](sdrr-gen/src/main.rs):
    - `Args::stm` clap comment
    - `parse_stm_variant()` function
  - [`sdrr-gen/src/rom_types.rs`](sdrr-gen/src/rom_types.rs):
    - `StmProcessor`
    - `StmVariant`
- Add a new linker scripts to [`sdrr/link/`](/sdrr/link/) - use the existing ones as a reference.
- Add its max frequency to [`sdrr/include/include.h`](/sdrr/include/include.h) - search for the pre-processor `TARGET_FREQ_MHZ` tests.
- Add any support specifically for this STM32 variant to [`sdrr/src/`](/sdrr/src/) and [`sdrr/include`](/sdrr/include/) - grep for "STM32F411" and "STM32F405" for examples of variant specific code.

## STM32F4 Family Comparisons

For completeness, all of the STM32F4xxR variants are compared in the following table.  All of these variants proivde the Cortex-M4F core.

| Feature | F401 | F405 | F410 | F411 | F412 | F413 | F415 | F423 | F446 |
|---------|------|------|------|------|------|------|------|------|------|
| **Max Freq** | 84 MHz | 168 MHz | 100 MHz | 100 MHz | 100 MHz | 100 MHz | 168 MHz | 100 MHz | 180 MHz |
| **Flash** | 25128-512 KB | 512 KB-1 MB | 64-128 KB | 256-512 KB | 512 KB-1 MB | 1-1.5 MB | 512 KB-1 MB | 1-1.5 MB | 256-512 KB |
| **SRAM** | 96 KB | 192 KB | 32 KB | 128 KB | 256 KB | 320 KB | 192 KB | 320 KB | 128 KB |
